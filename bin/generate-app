#!/usr/bin/env node

var path          = require('path')
  , resolveProjectRoot = require('cjs-module/resolve-project-root')
  , projectRoot = process.cwd()
  , appName = process.argv[2]
  , allowedPattern = /[0-9a-z\-]+/
  , match
  , appRootPath;

if (!appName) {
	throw new Error('No appName argument provided');
}

match = appName.match(allowedPattern);
if (!match || (match[0].length !== appName.length)) {
	throw new Error('Illegal characters in app name, use only: [0-9a-z-]');
}

resolveProjectRoot(projectRoot).done(function (root) {
	if (!root) {
		throw new Error('Could not located project in projectRoot: ' + projectRoot);
	}
	appRootPath = 'apps' + path.sep + appName;
	require('../scripts/generate-app')(root, appName).done(function () {
		console.log("Successfully created " + appName + " application." +
				"\nIt's located in: " + appRootPath + "." +
				"\n\nIn order to setup application you need to: \n" +
				"\n1. Expose app in apps/routes.js configuration" +
				"\n2. Configure application url tree in apps/" + appName + "/routes.js" +
				"\n3. Provide app configuration for data access rules in apps/access.js" +
				"\n4. Setup dbjs dom bindings in apps/" + appName + "/client/dbjs-dom.js" +
				"\n5. Configure model needed for application client in apps/" +
			appName + "/client/model.js" +
				"\n6. Ensure POST (form submissions) controllers " +
			"configuration is complete in apps/" + appName + "/controller");
	});
});

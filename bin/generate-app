#!/usr/bin/env node

var path          = require('path')
  , resolveProjectRoot = require('cjs-module/resolve-project-root')
  , projectRoot = process.cwd()
  , appName = process.argv[2]
  , allowedPattern = /[0-9a-z\-]+/
  , match
  , appRootPath;

if (!appName) {
	throw new Error('No appName argument provided');
}

match = appName.match(allowedPattern);
if (!match || (match[0].length !== appName.length)) {
	throw new Error('Illegal characters in app name, use only: [0-9a-z-]');
}

resolveProjectRoot(projectRoot).done(function (root) {
	if (!root) {
		throw new Error('Could not located project in projectRoot: ' + projectRoot);
	}
	appRootPath = path.resolve(root, 'apps', appName);
	require('../scripts/generate-app')(root, appName).done(function () {
		console.log("Successfully created " + appName + " application." +
				"\nIt's located in: " + appRootPath + "." +
				"\n\nIn order to setup application you need to: \n" +
				"\n1. Setup main config in apps/routes.js (common for all apps)" +
				"\n2. Setup view paths in apps/" + appName + "/routes.js" +
				"\n3. Setup data access for client in apps/access.js (common for all apps)" +
				"\n4. Setup dbjs dom bindings in apps/" + appName + "/client/dbjs-dom.js" +
				"\n5. Require needed models in client model apps/" + appName + "/client/model.js" +
				"\n6. (optional) Customize controllers in apps/" + appName + "/controller");
	});
});
